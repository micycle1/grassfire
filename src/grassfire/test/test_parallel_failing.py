import unittest

from tri.delaunay.helpers import ToPointsAndSegments
from grassfire import calc_skel
from grassfire.events import at_same_location


PAUSE = False
OUTPUT = False
LOGGING = False

class TestMoreAdvancedParallelEvents(unittest.TestCase):
    def setUp(self):
       pass


    def test_capital_T(self):
        """Capital T, has more than one triangle in parallel fan

        Exhibits infinite event loop because of flipping; when all flip
        events are handled first inside the event loop
        """
        ring = [(15.5055, 28.7004), (20.8063, 28.7004), (20.8063, 44.1211), (26.7445, 44.1211), (26.7445, 47.8328), (9.5668, 47.8328), (9.5668, 44.1211), (15.5055, 44.1211), (15.5055, 28.7004)]
        conv = ToPointsAndSegments()
        conv.add_polygon([ring])
        skel = calc_skel(conv, pause=PAUSE, output=OUTPUT)
        assert len(skel.segments()) == 21, len(skel.segments())
        assert len(skel.sk_nodes) == 14, len(skel.sk_nodes)
        not_stopped = list(filter(lambda v: v.stops_at is None, skel.vertices))
        stopped = list(filter(lambda v: v.stops_at is not None, skel.vertices))
        assert len(not_stopped) == 8, len(not_stopped)
        assert len(stopped) == 13, len(stopped)
        for v in skel.vertices:
            assert at_same_location((v.start_node, v), v.starts_at)
            if v.stops_at is not None and not v.inf_fast:
                assert at_same_location((v.stop_node, v), v.stops_at), \
                    "{} {} {}".format(id(v),
                                      v.stop_node.pos,
                                      v.position_at(v.stops_at) )

    def test_small_t(self):
        ring = [(100.908, 42.0027), (100.908, 40.2512), (103.188, 40.2512), (103.188, 31.7734), (103.250359375, 30.4847203125), (103.393189453, 29.8978896484), (103.668125, 29.3748875), (104.118419922, 28.9348306641), (104.787328125, 28.5968359375), (105.718103516, 28.3800201172), (106.954, 28.3035), (107.811, 28.3438375), (108.677, 28.4609), (108.677, 30.3953), (107.35, 30.2371), (106.713328125, 30.322746875), (106.191125, 30.58245), (105.837859375, 31.020353125), (105.708, 31.6406), (105.708, 40.2512), (108.782, 40.2512), (108.782, 42.0027), (105.708, 42.0027), (105.708, 45.634), (103.188, 44.8391), (103.188, 42.0012), (100.908, 42.0027)],
        conv = ToPointsAndSegments()
        conv.add_polygon(ring)
        skel = calc_skel(conv, pause=PAUSE, output=OUTPUT)
        assert len(skel.segments()) == 89, len(skel.segments())
        assert len(skel.sk_nodes) == 64, len(skel.sk_nodes)
        not_stopped = list(filter(lambda v: v.stops_at is None, skel.vertices))
        stopped = list(filter(lambda v: v.stops_at is not None, skel.vertices))
        assert len(not_stopped) == 10, len(not_stopped)
        self.assertEqual(len(stopped), 79)
        for v in skel.vertices:
            assert at_same_location((v.start_node, v), v.starts_at)
            if v.stops_at is not None and not v.inf_fast:
                assert at_same_location((v.stop_node, v), v.stops_at), \
                    "{} {} {}".format(id(v),
                                      v.stop_node.pos,
                                      v.position_at(v.stops_at) )


    def test_goes(self):
        segments = [ ((51076.45,391503.5),(51075.45,391503.4)), ((51075.45,391503.4),(51075.25,391504.65)), ((51075.25,391504.65),(51073.85,391504.45)), ((51085.65,391504.8),(51084.55,391504.7)), ((51076.25,391504.9),(51076.45,391503.5)), ((51073.85,391504.45),(51073.7,391505.55)), ((51090.35,391507.3),(51086.8,391506.85)), ((51091.2,391506.4),(51090.4,391506.4)), ((51086.8,391506.5),(51085.5,391506.3)), ((51091.1,391507.45),(51091.2,391506.4)), ((51086.8,391506.85),(51086.8,391506.5)), ((51090.4,391506.4),(51090.35,391507.3)), ((51084.55,391504.7),(51084.45,391506.05)), ((51084.45,391506.05),(51076.25,391504.9)), ((51073.7,391505.55),(51075.0,391505.7)), ((51085.5,391506.3),(51085.65,391504.8)), ((51092.6,391507.7),(51091.1,391507.45)), ((51046.9,391511.9),(51046.75,391512.9)), ((51046.75,391512.9),(51047.95,391513.05)), ((51102.4,391509.15),(51100.15,391508.6)), ((51103.9,391510.2),(51102.4,391509.15)), ((51048.55,391511.0),(51048.2,391510.95)), ((51048.2,391510.95),(51048.05,391512.05)), ((51054.55,391511.9),(51053.55,391511.75)), ((51100.15,391508.6),(51099.65,391508.5)), ((51049.9,391510.95),(51048.95,391510.8)), ((51072.95,391510.0),(51072.75,391511.5)), ((51074.4,391510.2),(51072.95,391510.0)), ((51048.95,391510.8),(51048.55,391511.0)), ((51050.6,391511.7),(51049.9,391510.95)), ((51072.75,391511.5),(51074.2,391511.7)), ((51075.0,391505.7),(51074.4,391510.2)), ((51050.45,391512.5),(51050.6,391511.7)), ((51053.55,391511.75),(51053.4,391512.9)), ((51048.05,391512.05),(51046.9,391511.9)), ((51054.4,391513.05),(51054.55,391511.9)), ((51053.4,391512.9),(51050.45,391512.5)), ((51064.5,391513.4),(51063.45,391513.25)), ((51059.6,391512.7),(51058.55,391512.55)), ((51058.55,391512.55),(51058.4,391513.6)), ((51059.45,391513.8),(51059.6,391512.7)), ((51058.4,391513.6),(51054.4,391513.05)), ((51046.4,391515.7),(51046.3,391516.65)), ((51046.9,391520.8),(51045.7,391520.65)), ((51110.65,391520.65),(51109.95,391520.25)), ((51109.35,391521.0),(51109.95,391520.25)), ((51108.15,391520.45),(51109.35,391521.0)), ((51045.55,391521.75),(51046.7,391521.9)), ((51045.7,391520.65),(51045.55,391521.75)), ((51110.6,391524.7),(51109.85,391521.7)), ((51110.65,391520.65),(51109.85,391521.7)), ((51110.6,391524.7),(51111.85,391524.9)), ((51111.75,391526.2),(51111.85,391524.9)), ((51111.75,391526.2),(51110.6,391526.1)), ((51110.6,391526.1),(51110.45,391527.65)), ((51111.5,391527.8),(51110.45,391527.65)), ((51111.4,391528.95),(51110.55,391528.85)), ((51111.5,391527.8),(51111.4,391528.95)), ((51047.95,391513.05),(51047.55,391515.85)), ((51073.75,391514.95),(51072.2,391514.75)), ((51072.2,391514.75),(51072.05,391515.65)), ((51099.65,391508.5),(51098.0,391514.6)), ((51091.75,391514.2),(51092.6,391507.7)), ((51109.4,391514.1),(51103.9,391510.2)), ((51074.2,391511.7),(51073.75,391514.95)), ((51103.9,391510.2),(51102.45,391519.7)), ((51098.5,391519.3),(51100.15,391508.6)), ((51063.45,391513.25),(51063.3,391514.3)), ((51064.35,391514.55),(51064.5,391513.4)), ((51063.3,391514.3),(51059.45,391513.8)), ((51069.45,391514.15),(51068.45,391514.05)), ((51098.0,391514.6),(51091.75,391514.2)), ((51069.3,391515.3),(51069.45,391514.15)), ((51068.45,391514.05),(51068.3,391515.05)), ((51068.3,391515.05),(51064.35,391514.55)), ((51072.05,391515.65),(51069.3,391515.3)), ((51047.55,391515.85),(51046.4,391515.7)), ((51117.5,391516.3),(51109.4,391514.1)), ((51047.45,391516.8),(51046.9,391520.8)), ((51046.3,391516.65),(51047.45,391516.8)), ((51108.1,391519.3),(51106.75,391519.2)), ((51102.45,391519.7),(51098.5,391519.3)), ((51106.75,391519.2),(51106.6,391520.2)), ((51106.6,391520.2),(51098.5,391519.3)), ((51108.1,391519.3),(51108.15,391520.45)), ((51043.6,391535.0),(51043.5,391536.05)), ((51043.5,391536.05),(51044.6,391536.25)), ((51043.1,391538.6),(51042.95,391539.55)), ((51044.35,391540.9),(51044.5,391541.35)), ((51044.5,391541.35),(51045.45,391541.45)), ((51049.25,391541.65),(51050.35,391541.8)), ((51044.05,391539.7),(51043.9,391540.85)), ((51042.95,391539.55),(51044.05,391539.7)), ((51046.5,391540.15),(51049.45,391540.55)), ((51043.9,391540.85),(51044.35,391540.9)), ((51046.4,391540.75),(51046.5,391540.15)), ((51045.45,391541.45),(51046.4,391540.75)), ((51049.45,391540.55),(51049.25,391541.65)), ((51050.35,391541.8),(51050.5,391540.7)), ((51059.15,391543.1),(51060.25,391543.25)), ((51064.3,391542.75),(51064.15,391543.9)), ((51065.3,391542.95),(51068.15,391543.55)), ((51065.15,391544.05),(51065.3,391542.95)), ((51064.15,391543.9),(51065.15,391544.05)), ((51068.0,391544.5),(51069.5,391544.7)), ((51108.5,391543.9),(51109.45,391543.65)), ((51068.15,391543.55),(51068.0,391544.5)), ((51108.5,391543.9),(51108.4,391546.1)), ((51108.4,391546.1),(51109.15,391546.15)), ((51069.5,391544.7),(51069.1,391547.8)), ((51069.1,391547.8),(51067.65,391547.6)), ((51109.0,391547.5),(51109.15,391546.15)), ((51108.25,391541.55),(51109.6,391542.3)), ((51055.45,391541.45),(51059.35,391541.95)), ((51054.35,391541.25),(51054.2,391542.35)), ((51055.3,391542.5),(51055.45,391541.45)), ((51108.25,391541.55),(51108.35,391539.35)), ((51050.5,391540.7),(51054.35,391541.25)), ((51054.2,391542.35),(51055.3,391542.5)), ((51059.35,391541.95),(51059.15,391543.1)), ((51060.25,391543.25),(51060.35,391542.2)), ((51109.6,391542.3),(51109.45,391543.65)), ((51060.35,391542.2),(51064.3,391542.75)), ((51109.35,391537.05),(51110.0,391537.15)), ((51044.6,391536.25),(51044.25,391538.75)), ((51109.9,391538.3),(51110.0,391537.15)), ((51044.25,391538.75),(51043.1,391538.6)), ((51114.7,391538.3),(51109.9,391538.3)), ((51109.9,391538.3),(51109.85,391538.6)), ((51109.85,391538.6),(51108.35,391539.35)), ((51109.8,391533.55),(51110.55,391533.8)), ((51044.25,391530.85),(51045.35,391531.0)), ((51045.35,391531.0),(51044.8,391535.15)), ((51109.2,391532.6),(51109.8,391533.55)), ((51044.4,391529.85),(51044.25,391530.85)), ((51045.6,391530.05),(51044.4,391529.85)), ((51109.2,391532.6),(51109.55,391530.0)), ((51116.0,391529.6),(51117.5,391516.3)), ((51046.7,391521.9),(51045.6,391530.05)), ((51116.0,391529.6),(51111.4,391528.95)), ((51110.55,391528.85),(51109.55,391530.0)), ((51110.55,391533.8),(51110.35,391534.85)), ((51044.8,391535.15),(51043.6,391535.0)), ((51109.65,391534.95),(51110.35,391534.85)), ((51109.35,391537.05),(51109.65,391534.95)), ((51114.7,391538.3),(51116.0,391529.6)), ((51066.75,391553.8),(51066.6,391555.0)), ((51088.2,391551.9),(51094.7,391552.0)), ((51076.9,391557.8),(51078.05,391557.95)), ((51067.95,391555.2),(51067.8,391556.55)), ((51069.1,391555.35),(51077.1,391556.6)), ((51068.8,391549.25),(51068.2,391554.0)), ((51103.45,391553.75),(51098.5,391553.45)), ((51098.5,391553.45),(51089.3,391553.25)), ((51111.85,391555.05),(51103.45,391553.75)), ((51068.2,391554.0),(51066.75,391553.8)), ((51087.65,391557.55),(51088.2,391551.9)), ((51066.6,391555.0),(51067.95,391555.2)), ((51068.9,391556.7),(51069.1,391555.35)), ((51067.8,391556.55),(51068.9,391556.7)), ((51078.25,391556.65),(51087.65,391557.55)), ((51077.1,391556.6),(51076.9,391557.8)), ((51078.05,391557.95),(51078.25,391556.65)), ((51087.2,391561.25),(51087.05,391561.25)), ((51081.65,391563.15),(51076.55,391562.45)), ((51087.05,391561.25),(51086.5,391565.2)), ((51081.4,391564.6),(51081.65,391563.15)), ((51091.3,391562.6),(51110.1,391565.85)), ((51090.45,391566.55),(51091.3,391562.6)), ((51086.5,391565.2),(51081.4,391564.6)), ((51086.95,391565.15),(51086.5,391565.2)), ((51082.6,391559.55),(51076.75,391559.15)), ((51097.45,391558.95),(51110.95,391561.1)), ((51097.3,391561.2),(51097.45,391558.95)), ((51110.95,391561.1),(51111.85,391555.05)), ((51089.3,391553.25),(51088.35,391559.85)), ((51082.6,391560.75),(51082.6,391559.55)), ((51097.3,391561.2),(51087.45,391559.75)), ((51087.45,391559.75),(51087.2,391561.25)), ((51088.35,391559.85),(51097.3,391561.2)), ((51097.3,391561.2),(51091.7,391560.75)), ((51087.05,391561.25),(51082.6,391560.75)), ((51110.1,391565.85),(51110.95,391561.1)), ((51076.75,391559.15),(51076.55,391562.45)), ((51091.3,391562.6),(51091.7,391560.75)), ((51090.35,391567.35),(51090.45,391566.55)), ((51076.55,391562.45),(51076.15,391568.75)), ((51086.95,391565.15),(51086.45,391570.2)), ((51076.15,391568.75),(51076.1,391568.75)), ((51090.35,391567.35),(51089.95,391570.5)), ((51076.1,391568.75),(51076.05,391569.9)), ((51086.45,391570.2),(51076.15,391568.75)), ((51087.95,391576.1),(51085.1,391575.7)), ((51089.85,391575.1),(51092.4,391575.6)), ((51092.4,391575.6),(51093.3,391575.75)), ((51089.85,391575.1),(51089.55,391576.15)), ((51085.1,391575.7),(51085.05,391576.15)), ((51093.3,391575.75),(51093.2,391576.45)), ((51087.95,391576.1),(51089.55,391576.15)), ((51087.0,391586.5),(51085.3,391586.1)), ((51085.45,391582.4),(51085.3,391586.1)), ((51093.2,391576.45),(51107.7,391580.05)), ((51089.8,391579.75),(51088.55,391579.45)), ((51075.55,391575.6),(51074.7,391581.15)), ((51107.7,391580.05),(51108.5,391575.3)), ((51085.05,391576.15),(51084.85,391580.35)), ((51106.9,391584.05),(51107.7,391580.05)), ((51092.55,391580.45),(51089.8,391579.75)), ((51085.55,391580.45),(51084.85,391580.35)), ((51088.0,391583.7),(51088.55,391579.45)), ((51085.55,391580.45),(51085.45,391582.4)), ((51106.9,391584.05),(51092.55,391580.45)), ((51074.7,391581.15),(51085.45,391582.4)), ((51088.0,391583.7),(51088.45,391579.8)), ((51074.7,391581.15),(51073.85,391586.8)), ((51088.45,391579.8),(51087.0,391586.5)), ((51087.4,391589.05),(51105.0,391593.9)), ((51102.3,391606.85),(51101.4,391606.7)), ((51070.95,391611.35),(51071.65,391611.45)), ((51070.95,391611.35),(51076.6,391612.05)), ((51071.65,391611.45),(51076.6,391612.05)), ((51101.1,391615.45),(51102.3,391606.85)), ((51078.65,391612.35),(51079.55,391612.45)), ((51076.6,391612.05),(51078.65,391612.35)), ((51076.6,391612.05),(51079.55,391612.45)), ((51079.55,391612.45),(51079.5,391612.75)), ((51079.5,391612.75),(51086.0,391613.6)), ((51086.0,391613.6),(51094.7,391614.7)), ((51094.7,391614.7),(51094.7,391614.6)), ((51094.7,391614.6),(51101.1,391615.45)), ((51102.45,391599.2),(51102.45,391599.15)), ((51102.45,391599.15),(51088.2,391597.3)), ((51073.05,391594.15),(51086.35,391595.85)), ((51088.2,391597.3),(51073.0,391595.3)), ((51086.35,391595.85),(51087.4,391589.05)), ((51101.4,391606.7),(51102.45,391599.15)), ((51101.4,391606.7),(51102.45,391599.2)), ((51073.0,391595.3),(51070.95,391611.35)), ((51088.2,391597.3),(51086.0,391613.6)), ((51073.85,391586.8),(51073.8,391587.25)), ((51079.75,391588.0),(51073.8,391587.25)), ((51079.75,391588.0),(51079.7,391587.55)), ((51088.0,391583.7),(51087.5,391588.2)), ((51106.1,391588.25),(51088.0,391583.7)), ((51106.1,391588.25),(51106.9,391584.05)), ((51105.0,391593.9),(51106.1,391588.25)), ((51073.8,391587.25),(51073.05,391594.15)), ((51079.7,391587.55),(51087.5,391588.2)), ((51087.4,391589.05),(51087.5,391588.2)), ((51092.9,391572.65),(51093.15,391571.25)), ((51109.3,391570.6),(51110.1,391565.85)), ((51076.05,391569.9),(51075.6,391575.05)), ((51109.3,391570.6),(51090.35,391567.35)), ((51093.15,391571.25),(51089.95,391570.5)), ((51108.5,391575.3),(51109.3,391570.6)), ((51075.6,391575.05),(51075.55,391575.6)), ((51092.9,391572.65),(51108.5,391575.3)), ((51092.4,391575.6),(51092.9,391572.65)), ((51085.05,391576.15),(51075.6,391575.05)), ((51104.05,391549.0),(51104.15,391549.0)), ((51067.65,391547.6),(51067.45,391549.05)), ((51095.35,391547.85),(51104.05,391549.0)), ((51109.0,391547.5),(51113.35,391548.05)), ((51113.35,391548.05),(51114.7,391538.3)), ((51067.45,391549.05),(51068.8,391549.25)), ((51094.7,391552.0),(51095.35,391547.85)), ((51111.85,391555.05),(51113.35,391548.05)), ((51104.15,391549.0),(51103.45,391553.75)) ]
        conv = ToPointsAndSegments()
        for line in segments:
            conv.add_point(line[0])
            conv.add_point(line[1])
            conv.add_segment(*line)
        skel = calc_skel(conv, pause=PAUSE, output=OUTPUT)
        assert len(skel.segments()) == 985, len(skel.segments())
        assert len(skel.sk_nodes) == 718, len(skel.sk_nodes)
        self.assertEqual(len(list(filter(lambda v: v.stops_at is None, skel.vertices))), 17)
        self.assertEqual(len(list(filter(lambda v: v.stops_at is not None, skel.vertices))), 968)
        for v in skel.vertices:
            assert at_same_location((v.start_node, v), v.starts_at)
            if v.stops_at is not None and not v.inf_fast:
                assert at_same_location((v.stop_node, v), v.stops_at), \
                    "{} {} {}".format(id(v),
                                      v.stop_node.pos,
                                      v.position_at(v.stops_at) )

    def test_capital_U(self):
        polys = [
        [(38.3852, 32.0156), (39.2659501953, 32.0912681641), (40.0374453125, 32.3105390625), (40.6971646484, 32.6618123047), (41.2425875, 33.1334875), (41.6711931641, 33.7139642578), (41.9804609375, 34.3916421875), (42.1678701172, 35.1549208984), (42.2309, 35.9922), (42.2309, 47.834), (47.5316, 47.834), (47.5316, 35.7273), (47.4732092773, 34.7657740479), (47.3213726562, 33.8784173828), (47.081449707, 33.063555542), (46.7588, 32.3195140625), (46.3587831055, 31.6446184814), (45.8867585938, 31.0371943359), (45.3480860352, 30.4955671631), (44.748125, 30.0180625), (44.0922350586, 29.6030058838), (43.3857757812, 29.2487228516), (41.8425875, 28.7157796875), (40.1614367187, 28.4058373047), (38.3852, 28.3055), (36.6090451172, 28.4058373047), (34.9279234375, 28.7157796875), (33.3847244141, 29.2487228516), (32.6782488525, 29.6030058838), (32.0223375, 30.0180625), (31.4223515381, 30.4955671631), (30.8836521484, 31.0371943359), (30.4116005127, 31.6446184814), (30.0115578125, 32.3195140625), (29.6888852295, 33.063555542), (29.4489439453, 33.8784173828), (29.2970951416, 34.7657740479), (29.2387, 35.7273), (29.2387, 47.834), (34.5395, 47.834), (34.5395, 35.9922), (34.6025257812, 35.1549208984), (34.789925, 34.3916421875), (35.0991804687, 33.7139642578), (35.527775, 33.1334875), (36.0731914062, 32.6618123047), (36.7329125, 32.3105390625), (37.5044210937, 32.0912681641), (38.3852, 32.0156)],
        ]
        conv = ToPointsAndSegments()
        for ring in polys:
            conv.add_polygon([ring])
        skel = calc_skel(conv, pause=False, output=OUTPUT, shrink=True)#, pause=False, output=False)
        assert len(skel.segments()) == 158, len(skel.segments())
        self.assertEqual(len(skel.sk_nodes), 111)
        not_stopped = list(filter(lambda v: v.stops_at is None, skel.vertices))
        stopped = list(filter(lambda v: v.stops_at is not None, skel.vertices))
        assert len(not_stopped) == 30, len(not_stopped)
        assert len(stopped) == 128, len(stopped)
        for v in skel.vertices:
            assert at_same_location((v.start_node, v), v.starts_at)


    def test_tudelft_logo(self):
        polys = [
        [(28.2387, 57.1504), (27.7545962891, 57.0337472656), (27.2828078125, 56.993484375), (26.8394935547, 57.0375167969), (26.4408125, 57.17375), (26.1029236328, 57.4100894531), (25.8419859375, 57.754440625), (25.6741583984, 58.2147089844), (25.6156, 58.7988), (25.6856849121, 59.2881812744), (25.8839386719, 59.7683330078), (26.1934848145, 60.2400170654), (26.597446875, 60.7039953125), (27.6211128906, 61.6118818359), (28.819925, 62.4980875), (30.0588714844, 63.3687072266), (31.202940625, 64.2298359375), (32.1171207031, 65.0875685547), (32.4458111816, 65.5170659912), (32.6664, 65.948), (32.8248125, 66.6851625), (32.7710109375, 66.9061765625), (32.6176, 66.9805), (32.5208703125, 66.9222546875), (32.4679125, 66.7729125), (32.3706484375, 66.5442390625), (32.141, 66.248), (31.1034759766, 65.3984353516), (29.9355515625, 64.7423015625), (28.6692482422, 64.2321388672), (27.3365875, 63.8204875), (24.6002796875, 63.1028796875), (23.2606755859, 62.7020037109), (21.9828, 62.2098), (20.9997419922, 61.7483013672), (19.7656484375, 61.0788734375), (18.4207775391, 60.1820806641), (17.1053875, 59.0384875), (16.5025784912, 58.3680671631), (15.9597365234, 57.6286583984), (15.4943938721, 56.8178317627), (15.1240828125, 55.9331578125), (14.8663356201, 54.9722071045), (14.7386845703, 53.9325501953), (14.7586619385, 52.8117576416), (14.9438, 51.6074), (15.122925, 50.8023), (15.252640625, 50.40393125), (15.3949, 50.2336), (15.5243578125, 50.3437421875), (15.5897375, 50.6433625), (15.6117, 51.6262), (15.6561465332, 52.3362411621), (15.8000691406, 52.9857136719), (16.031892334, 53.5809723145), (16.340040625, 54.128371875), (17.1390105469, 55.1050128906), (18.104375, 55.966475), (20.163871875, 57.547215625), (21.0727964844, 58.3681707031), (21.7777, 59.2773), (22.104725, 59.739675), (22.2554875, 59.862834375), (22.3512, 59.8191), (22.3023, 59.3027), (22.0503148438, 58.5393394531), (21.6885625, 57.836665625), (20.851325, 56.570375), (20.4836242188, 55.9852566406), (20.221725, 55.417821875), (20.1195195312, 54.8573199219), (20.2309, 54.293), (20.6030839844, 53.7075248047), (21.082534375, 53.4021359375), (21.6320488281, 53.3341009766), (22.214425, 53.4606875), (22.7924605469, 53.7391630859), (23.328953125, 54.1267953125), (23.7867003906, 54.5808517578), (24.1285, 55.0586), (24.368925, 55.470225), (24.465971875, 55.57165625), (24.5609, 55.5859), (24.6368625, 55.3106625), (24.5941, 54.791), (24.2621640625, 53.2469984375), (23.7833125, 51.9836375), (23.4592181641, 51.4272880859), (23.0629046875, 50.9052078125), (22.0063, 49.916), (21.566953125, 49.6562546875), (21.130475, 49.4675625), (20.815009375, 49.2970390625), (20.7395761719, 49.2020642578), (20.7387, 49.0918), (20.9814125, 49.0273125), (21.4195, 49.0469), (22.2465202881, 49.156970874), (23.0534919922, 49.3736341797), (23.8374688721, 49.6869346924), (24.5955046875, 50.0869171875), (26.0219681641, 51.1071072266), (27.3093125, 52.3545625), (28.4339677734, 53.7496412109), (29.3723640625, 55.2127015625), (30.1009314453, 56.6641017578), (30.5961, 58.0242), (30.6886375, 58.3597625), (30.6215, 58.5781), (30.509940625, 58.5979578125), (30.381, 58.5274875), (30.0922, 58.2668), (29.2161125, 57.616425), (28.2387, 57.1504)],
        [(15.5055, 28.7004), (20.8063, 28.7004), (20.8063, 44.1211), (26.7445, 44.1211), (26.7445, 47.8328), (9.5668, 47.8328), (9.5668, 44.1211), (15.5055, 44.1211), (15.5055, 28.7004)],
        [(38.3852, 32.0156), (39.2659501953, 32.0912681641), (40.0374453125, 32.3105390625), (40.6971646484, 32.6618123047), (41.2425875, 33.1334875), (41.6711931641, 33.7139642578), (41.9804609375, 34.3916421875), (42.1678701172, 35.1549208984), (42.2309, 35.9922), (42.2309, 47.834), (47.5316, 47.834), (47.5316, 35.7273), (47.4732092773, 34.7657740479), (47.3213726562, 33.8784173828), (47.081449707, 33.063555542), (46.7588, 32.3195140625), (46.3587831055, 31.6446184814), (45.8867585938, 31.0371943359), (45.3480860352, 30.4955671631), (44.748125, 30.0180625), (44.0922350586, 29.6030058838), (43.3857757812, 29.2487228516), (41.8425875, 28.7157796875), (40.1614367187, 28.4058373047), (38.3852, 28.3055), (36.6090451172, 28.4058373047), (34.9279234375, 28.7157796875), (33.3847244141, 29.2487228516), (32.6782488525, 29.6030058838), (32.0223375, 30.0180625), (31.4223515381, 30.4955671631), (30.8836521484, 31.0371943359), (30.4116005127, 31.6446184814), (30.0115578125, 32.3195140625), (29.6888852295, 33.063555542), (29.4489439453, 33.8784173828), (29.2970951416, 34.7657740479), (29.2387, 35.7273), (29.2387, 47.834), (34.5395, 47.834), (34.5395, 35.9922), (34.6025257812, 35.1549208984), (34.789925, 34.3916421875), (35.0991804687, 33.7139642578), (35.527775, 33.1334875), (36.0731914062, 32.6618123047), (36.7329125, 32.3105390625), (37.5044210937, 32.0912681641), (38.3852, 32.0156)],
        [(55.4875, 45.5563), (59.4066, 45.5563), (60.2057835693, 45.5178564697),
         (60.9454076172, 45.4051830078), (61.6265759033, 45.2222653076),
         (62.2503921875, 44.9730890625), (62.8179602295, 44.6616399658),
         (63.3303837891, 44.2919037109), (64.1942125, 43.3935125),
         (64.8507083984, 42.3098009766), (65.3087015625, 41.0726546875),
         (65.5770220703, 39.7139591797), (65.6645, 38.2656),
         (65.5770220703, 36.8175103516), (65.3087015625, 35.4592765625),
         (64.8507083984, 34.2227138672), (64.1942125, 33.1396375),
         (63.3303837891, 32.2418626953), (62.8179602295, 31.8724056396),
         (62.2503921875, 31.5612046875), (61.6265759033, 31.3122367432),
         (60.9454076172, 31.1294787109), (60.2057835693, 31.0169074951),
         (59.4066, 30.9785), (55.4875, 30.9785),
         (55.4875, 45.5563)],
        [
         (52.8324, 28.7004), (59.4059, 28.7004),
         (60.8560672363, 28.7788331543),
         (62.1440332031, 29.0031808594),
         (63.2792692871, 29.3570154785), (64.271246875, 29.823909375), (65.1294373535, 30.3874349121), (65.8633121094, 31.0311644531), (66.4823425293, 31.7386703613), (66.996, 32.493525), (67.4137559082, 33.2793007324), (67.7450816406, 34.0795699219), (68.186328125, 35.657878125), (68.3955105469, 37.0970285156), (68.4484, 38.2656), (68.3955105469, 39.4344525391), (68.186328125, 40.8740328125), (67.7450816406, 42.4528623047), (67.4137559082, 43.2534084717), (66.996, 44.0394625), (66.4823425293, 44.7945895752), (65.8633121094, 45.5023548828), (65.1294373535, 46.1463236084), (64.271246875, 46.7100609375), (63.2792692871, 47.1771320557), (62.1440332031, 47.5311021484), (60.8560672363, 47.7555364014), (59.4059, 47.834), (52.8324, 47.834), (52.8324, 28.7004)],
        [(82.9195, 34.8762), (82.9195, 36.123), (82.8224828125, 37.4505816406), (82.53454375, 38.658784375), (82.0603515625, 39.7298449219), (81.404575, 40.646), (80.5718828125, 41.3894863281), (79.56694375, 41.942540625), (78.3944265625, 42.2873996094), (77.059, 42.4063),(76.2952375244, 42.3687171631), (75.5838064453, 42.2585341797), (74.9242850342, 42.0795993408), (74.3162515625, 41.8357609375), (73.7592843018, 41.5308672607), (73.2529615234, 41.1687666016), (72.3905625, 40.2883375), (71.7256806641, 39.2252599609), (71.2549421875, 38.0103203125), (70.9749732422, 36.6743048828), (70.8824, 35.248), (70.9637001953, 33.823009375), (71.2144078125, 32.50744375), (71.6447333984, 31.3261375), (72.2648875, 30.303925), (73.0850806641, 29.465640625), (73.5733826904, 29.1232322266), (74.1155234375, 28.83611875), (74.7127792236, 28.6074044922), (75.3664263672, 28.44019375), (76.848, 28.3027), (77.9991910156, 28.3734771484), (79.058021875, 28.5858296875), (80.0117917969, 28.9397892578), (80.8478, 29.4353875), (81.5533457031, 30.0726560547), (82.115728125, 30.8516265625), (82.5222464844, 31.7723306641), (82.7602, 32.8348), (80.1098, 32.8348), (79.9671755859, 32.1632625), (79.7567359375, 31.59635), (79.4750064453, 31.1294125), (79.1185125, 30.7578), (78.6837794922, 30.4768625), (78.1673328125, 30.28195), (77.5656978516, 30.1684125), (76.8754, 30.1316), (75.9894021484, 30.2347720703), (75.2544671875, 30.5276953125), (74.6604455078, 30.9854802734), (74.1971875, 31.5832375), (73.8545435547, 32.2960775391), (73.6223640625, 33.0991109375), (73.4904994141, 33.9674482422), (73.4488, 34.8762), (82.9195, 34.8762), (82.9195, 34.8762)],
        [(73.5055, 36.6262), (73.5694832031, 37.3917933594), (73.744890625, 38.118946875), (74.0270464844, 38.7880457031),  (74.411275, 39.379475), (74.8929003906, 39.8736199219), (75.467246875, 40.250865625), (76.1296386719, 40.4915972656), (76.8754, 40.5762), (77.7209189453, 40.4999767578), (78.4335015625, 40.2795953125), (79.0193740234, 39.9274880859), (79.4847625, 39.4560875), (79.8358931641, 38.8778259766), (80.0789921875, 38.2051359375), (80.2202857422, 37.4504498047), (80.266, 36.6262), (73.5055, 36.6262)],
        [(85.973, 28.6992), (88.49331, 28.6992), (88.49331, 47.834), (85.973, 47.834), (85.973, 28.6992), (85.973, 28.6992)],
        [(96.3883, 28.7004), (96.3883, 40.2512), (99.4605, 40.2512), (99.4605, 42.0027), (96.3883, 42.0027), (96.3883, 44.1512), (96.4229054688, 44.6702857422), (96.52635625, 45.0817171875), (96.6981039062, 45.3973431641), (96.9376, 45.6290125), (97.2442960938, 45.7885740234), (97.61764375, 45.8878765625), (98.5621, 45.9531), (99.8336, 45.875), (99.8336, 47.9656), (98.9403125, 48.1487), (98.0309, 48.2313), (97.1673613281, 48.1749609375), (96.374484375, 48.004725), (95.6659777344, 47.7187640625), (95.05555, 47.31525), (94.5569097656, 46.7923546875), (94.183765625, 46.14825), (93.9498261719, 45.3811078125), (93.8688, 44.4891), (93.8688, 42.0027), (91.273, 42.0027), (91.273, 40.2512), (93.8688, 40.2512), (93.8688, 28.7004), (96.3883, 28.7004)],
        [(100.908, 42.0027), (100.908, 40.2512), (103.188, 40.2512), (103.188, 31.7734), (103.250359375, 30.4847203125), (103.393189453, 29.8978896484), (103.668125, 29.3748875), (104.118419922, 28.9348306641), (104.787328125, 28.5968359375), (105.718103516, 28.3800201172), (106.954, 28.3035), (107.811, 28.3438375), (108.677, 28.4609), (108.677, 30.3953), (107.35, 30.2371), (106.713328125, 30.322746875), (106.191125, 30.58245), (105.837859375, 31.020353125), (105.708, 31.6406), (105.708, 40.2512), (108.782, 40.2512), (108.782, 42.0027), (105.708, 42.0027), (105.708, 45.634), (103.188, 44.8391), (103.188, 42.0012), (100.908, 42.0027)],
        ]
        conv = ToPointsAndSegments()
        for ring in polys:
            conv.add_polygon([ring])
        skel = calc_skel(conv, pause=False, output=OUTPUT)#, pause=False, output=False)
        assert len(skel.segments()) == 1398, len(skel.segments())
        assert len(skel.sk_nodes) == 1041, len(skel.sk_nodes)
        not_stopped = list(filter(lambda v: v.stops_at is None, skel.vertices))
        stopped = list(filter(lambda v: v.stops_at is not None, skel.vertices))
        assert len(not_stopped) == 14, len(not_stopped)
        assert len(stopped) == 1384, len(stopped)
        for v in skel.vertices:
            assert at_same_location((v.start_node, v), v.starts_at)


if __name__ == "__main__":
    if LOGGING:
        import logging
        import sys
        root = logging.getLogger()
        root.setLevel(logging.WARNING)
        ch = logging.StreamHandler(sys.stdout)
        ch.setLevel(logging.DEBUG)
        formatter = logging.Formatter('%(asctime)s - %(message)s')
        ch.setFormatter(formatter)
        root.addHandler(ch)

    unittest.main(verbosity=2)